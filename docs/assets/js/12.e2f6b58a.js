(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{418:function(s,a,e){"use strict";e.r(a);var t=e(2),r=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("为搭建流水线实现一键docker部署，Jenkins脚本需要远程连接docker服务器执行docker pull或docker create等操作。因此Jenkins服务器需要远程连接应用服务器docker")]),s._v(" "),a("h2",{attrs:{id:"生成ca证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生成ca证书"}},[s._v("#")]),s._v(" 生成CA证书")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#============================================================================================")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#此形式是自己给自己签发证书,自己就是CA机构,也可以交给第三方机构去签发")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成根证书RSA私钥,password作为私钥密码（身份证）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"生成根证书RSA私钥..."')]),s._v("\nopenssl genrsa "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-passout")]),s._v(" pass:UBSSDIC "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-aes256")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" /root/.docker/ca-key.pem "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2.用根证书RSA私钥生成自签名的根证书(营业执照)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"用根证书RSA私钥生成自签名的根证书..."')]),s._v("\nopenssl req "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-x509")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-days")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3650")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-passin")]),s._v(" pass:UBSSDIC "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-key")]),s._v(" /root/.docker/ca-key.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-sha256")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-subj")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/C=CN/ST=GG/L=SZ/O=UBSSDIC/OU=UBSSDIC/CN=172.25.16.141"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" /root/.docker/ca.pem\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#============================================================================================")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#给服务器签发证书")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1.服务端生成自己的私钥")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"服务端生成自己的私钥..."')]),s._v("\nopenssl genrsa "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" /root/.docker/server-key.pem "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2.服务端生成证书(里面包含公钥与服务端信息)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"服务端生成证书..."')]),s._v("\nopenssl req "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-sha256")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-key")]),s._v(" /root/.docker/server-key.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" /root/.docker/server.csr "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-subj")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/CN=172.25.16.141"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3.通过什么形式与我进行连接,可设置多个IP地扯用逗号分隔")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"授权ip: 172.25.16.141, 0.0.0.0..."')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("subjectAltName")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("IP:172.25.16.141,IP:0.0.0.0 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /tmp/extfile.cnf\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 4.权威机构对证书进行进行盖章生效")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"权威机构对证书进行进行盖章生效..."')]),s._v("\nopenssl x509 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-passin")]),s._v(" pass:UBSSDIC "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-req")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-days")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3650")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-sha256")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-in")]),s._v(" /root/.docker/server.csr "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-CA")]),s._v(" /root/.docker/ca.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-CAkey")]),s._v(" /root/.docker/ca-key.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-CAcreateserial")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" /root/.docker/server-cert.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-extfile")]),s._v(" /tmp/extfile.cnf\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#============================================================================================")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#给客户端签发证书")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"给客户端签发证书..."')]),s._v("\nopenssl genrsa "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" /root/.docker/client-key.pem "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("\nopenssl req "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-subj")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/CN=client'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-key")]),s._v(" /root/.docker/client-key.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" /root/.docker/client.csr\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" extendedKeyUsage "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" clientAuth "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /tmp/extfile.cnf\nopenssl x509 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-passin")]),s._v(" pass:UBSSDIC "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-req")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-days")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3650")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-sha256")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-in")]),s._v(" /root/.docker/client.csr "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-CA")]),s._v(" /root/.docker/ca.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-CAkey")]),s._v(" /root/.docker/ca-key.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-CAcreateserial")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" /root/.docker/client-cert.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-extfile")]),s._v(" /tmp/extfile.cnf\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#============================================================================================")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清理文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"清理多余文件..."')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rf")]),s._v(" /root/.docker/ca-key.pem\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rf")]),s._v(" /root/.docker/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("server,client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(".csr\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rf")]),s._v(" /root/.docker/ca.srl\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最终文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ca.pem  ==  CA机构证书")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# client-cert.pem  ==  客户端证书")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# client-key.pem  ==  客户私钥")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# server-cert.pem  == 服务端证书")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# server-key.pem  ==  服务端私钥")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("h2",{attrs:{id:"配置服务端证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置服务端证书"}},[s._v("#")]),s._v(" 配置服务端证书")]),s._v(" "),a("p",[s._v("打开docker.service文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vim /lib/systemd/system/docker.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://blog-chy.oss-cn-shenzhen.aliyuncs.com/static/image-20230417101508866.png",alt:"image-20230417101508866"}})]),s._v(" "),a("h2",{attrs:{id:"重启docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重启docker"}},[s._v("#")]),s._v(" 重启docker")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启docker服务")]),s._v("\nsystemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" restart\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"连接测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#连接测试"}},[s._v("#")]),s._v(" 连接测试")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证证书")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--tlsverify")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--tlscacert")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--tlscert")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("client-cert.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--tlskey")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("client-key.pem "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" tcp://172.25.16.141:2376 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])])}),[],!1,null,null,null);a.default=r.exports}}]);